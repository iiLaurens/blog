<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>One-liner: Deploy python scipy stack with IPython notebook on AWS - Laurens' geeky adventures</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="../blog/ipython-notebook-aws-salt.html">

        <meta name="author" content="Daniel Rodriguez" />
        <meta name="keywords" content="Python,AWS,Salt,IPython Notebook" />
        <meta name="description" content="Problem: How many times have you needed to create a powerful EC2 instance with the the python scientific stack installed and the ipython notebook running? I have to do this at least 2 or 3 times every week. A simple solution is to have an AMI with all the libraries ..." />

        <meta property="og:site_name" content="Laurens' geeky adventures" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="One-liner: Deploy python scipy stack with IPython notebook on AWS"/>
        <meta property="og:url" content="../blog/ipython-notebook-aws-salt.html"/>
        <meta property="og:description" content="Problem: How many times have you needed to create a powerful EC2 instance with the the python scientific stack installed and the ipython notebook running? I have to do this at least 2 or 3 times every week. A simple solution is to have an AMI with all the libraries ..."/>
        <meta property="article:published_time" content="2013-11-27" />
            <meta property="article:section" content="11" />
            <meta property="article:tag" content="Python" />
            <meta property="article:tag" content="AWS" />
            <meta property="article:tag" content="Salt" />
            <meta property="article:tag" content="IPython Notebook" />
            <meta property="article:author" content="Daniel Rodriguez" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="../theme/css/bootstrap.yeti.min.css" type="text/css"/>
    <link href="../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="../theme/css/pygments/zenburn.css" rel="stylesheet">
    <link href="../theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="../theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="../" class="navbar-brand">
Laurens' geeky adventures            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li ><a href="../tags.html">Tags</a></li>
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="../archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="../blog/ipython-notebook-aws-salt.html"
                       rel="bookmark"
                       title="Permalink to One-liner: Deploy python scipy stack with IPython notebook on AWS">
                        One-liner: Deploy python scipy stack with IPython notebook on AWS
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-11-27T00:00:00+01:00"> 27-11-2013</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="../tags/python.html">Python</a>
        /
	<a href="../tags/aws.html">AWS</a>
        /
	<a href="../tags/salt.html">Salt</a>
        /
	<a href="../tags/ipython-notebook.html">IPython Notebook</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p><strong>Problem:</strong> How many times have you needed to create a powerful EC2 instance with the the python scientific stack
installed and the ipython notebook running? I have to do this at least 2 or 3 times every week.</p>
<p>A simple solution is to have an AMI with all the libraries ready and create a new instance every time,
you can even have the ipython notebook as an upstart service in ubuntu so it runs when the instance is ready.
That was my previous solution, but that was before I learned <a href="http://saltstack.com/">salt</a>.</p>
<p>The problem with the AMI solution is that it gets dated really quickly and while update it is not hard, it is
annoying. Also having to login into AWS, look for the AMI and spin up and instance is annoying.</p>
<p><strong>Solution:</strong> <a href="http://saltstack.com/">Salt</a> + <a href="http://continuum.io/downloads">Anaconda</a> + <a href="http://www.vagrantup.com/">Vagrant</a></p>
<p>Salt will do the provisioning of the instance using states, that makes the updates of new instances simple as changing a YAML file.
Anaconda is the best python scientific distribution I have found and the conda package manager is the perfect solution to install the scientific libraries, I don't want to compile numpy and scipy every time I create the instances, that takes at least 30 minutes.
Vagrant is used to create the instance and provision it with salt using one command.</p>
<p>Install conda using a salt states is pretty easy because salt has support for pip, and conda is pip
installable (you have to run <code>conda init</code> after <code>pip install conda</code>) so is as simple as:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">pip-packages</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">pip.installed</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">names</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conda</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">require</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pkg</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">python-dev</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pkg</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">python-pip</span>

<span class="l l-Scalar l-Scalar-Plain">conda-check</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">cmd.run</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;[</span><span class="nv"> </span><span class="s">-d</span><span class="nv"> </span><span class="s">/usr/conda-meta</span><span class="nv"> </span><span class="s">]</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&#39;changed=no&#39;</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&#39;changed=yes&#39;&quot;</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">stateful</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">require</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">conda</span>

<span class="c1"># This will create some files into /usr, needs root</span>
<span class="l l-Scalar l-Scalar-Plain">conda-init</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">cmd.wait</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;conda</span><span class="nv"> </span><span class="s">init&quot;</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">watch</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cmd</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">conda-check</span>
</pre></div>


<p>The main issue was that salt didn't have support for conda, so I <a href="http://github.com/danielfrg/salt-conda/blob/master/conda.py">wrote my first salt module</a> to manage conda virtual environments using salt.
The code below will create a conda virtual env and
install the ipython-notebook, numpy, scipy and pandas libraries using the conda repository
also will install luigi (or any other python library you want) using regular pip.
All of this will be inside the conda virtual env, because you <strong>should</strong> use virtual envs.</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">venv</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">conda.managed</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pkgs</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ipython-notebook,numpy,scipy,pandas,scikit-learn</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">require</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cmd</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">conda-init</span>

<span class="l l-Scalar l-Scalar-Plain">venv-pip</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">pip.installed</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">names</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">luigi</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bin_env</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/home/ubuntu/envs/venv/bin/pip</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">require</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conda</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">venv</span>
</pre></div>


<p>I created another module to start the ipython notebook in the background since salt does not support this natively, the state looks like this:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">/home/vagrant/nbserver.pid</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">nbserver.start_server</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ip</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0.0.0</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">nb_dir</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/home/ubuntu/notebooks</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">require</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conda</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">venv</span>
</pre></div>


<p>The final peace of the puzzle is how to spin up the instance quickly, Vagrant with the AWS provider is the solution.</p>
<p>Vagrant is mainly used for development, and I use it to develop this solution but it also has a nice
integration with AWS, so on the <code>Vagrantfile</code> you only need to change the AWS credentials and the
instance configuration.</p>
<div class="highlight"><pre><span></span><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># AWS Provider</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:aws</span> <span class="k">do</span> <span class="o">|</span><span class="n">aws</span><span class="p">,</span> <span class="n">override</span><span class="o">|</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">access_key_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">secret_access_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">keypair_name</span> <span class="o">=</span> <span class="s2">&quot;daniel_keypair&quot;</span>

    <span class="n">aws</span><span class="o">.</span><span class="n">security_groups</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;default&quot;</span><span class="o">]</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="s2">&quot;c3.xlarge&quot;</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">availability_zone</span> <span class="o">=</span> <span class="s2">&quot;us-east-a&quot;</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">ami</span> <span class="o">=</span> <span class="s2">&quot;ami-a73264ce&quot;</span>  <span class="c1"># Precise 12.04 64 bits</span>

    <span class="n">override</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;dummy&quot;</span>
    <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;ubuntu&quot;</span>
    <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">private_key_path</span> <span class="o">=</span> <span class="s2">&quot;~/.ssh/my_keypair.pem&quot;</span>
  <span class="k">end</span>
</pre></div>


<p>How you only need to run <code>vagrant up --provider aws</code> and it will create an instance and provision it
with salt. Then just go to the URL of the EC2 instance and the notebook will be running in port 80.</p>
<p>NOTE: Be sure to use a security group with port 22 and 80 open</p>
<p>There are more things you can configure for your notebook such as passwords and more security, take a look <a href="https://gist.github.com/iamatypeofwalrus/5183133">here</a>. Also there are more solutions available
such as <a href="https://www.wakari.io/">Continnums Wakari</a> that I personally think is an overkill, I am sure is perfect for some people but not for me.</p>
<p>This solution gives you the notebook up and running in two minutes, and if you need more control on the instance you can just SSH to it and do whatever you want. Also you only pay the Amazon fees, so for my personal needs is the perfect solution.</p>
<p>The whole code is on github: <a href="https://github.com/danielfrg/salt-conda">salt conda module</a>, look in <code>example/ipythonnb</code></p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'iilaurens'; // required: replace example with your forum shortname

                    var disqus_identifier = 'ipython-notebook-aws-salt';
                var disqus_url = '../blog/ipython-notebook-aws-salt.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2013 Laurens
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="../theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'iilaurens'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>